# 故障排除指南

## 🐛 已修复的问题

### 1. "Cannot read properties of undefined (reading 'length')" 错误
**原因：** `window.getSelection()` 可能返回 null  
**修复：** 添加了空值检查和默认值

### 2. 测试 API 连接没反应
**原因：** 
- 配置格式不匹配
- 消息响应格式不一致

**修复：**
- 统一了配置存储格式
- 修正了消息响应处理逻辑

---

## ✅ 使用步骤（重要）

### 第一步：配置 API

1. 点击扩展图标
2. 点击右上角 ⚙️ 进入设置
3. 选择翻译服务提供商（火山翻译或微软翻译）
4. 填写 API 密钥：
   - **火山翻译：** Access Key 和 Secret Key
   - **微软翻译：** API Key 和 Region
5. 点击「🧪 测试 API 连接」按钮
6. 看到「✅ API 测试成功！」提示
7. 点击「💾 保存设置」

### 第二步：测试翻译

1. 打开任意网页（如 Google、GitHub）
2. 选中一段英文文字
3. 等待 1 秒
4. 查看翻译浮窗

---

## 🔍 调试方法

### 查看控制台日志

#### 1. 查看 Background 日志
```
1. 打开 edge://extensions/
2. 找到「翻译扩展」
3. 点击「Service Worker」链接
4. 查看控制台输出
```

#### 2. 查看 Content Script 日志
```
1. 打开测试网页
2. 按 F12 打开开发者工具
3. 切换到 Console 标签
4. 选中文字触发翻译
5. 查看日志输出
```

#### 3. 查看 Options 页面日志
```
1. 右键扩展图标 → 选项
2. 按 F12 打开开发者工具
3. 点击「测试 API 连接」
4. 查看 Console 中的响应信息
```

---

## ⚠️ 常见问题

### Q1: 测试 API 提示"API 测试失败"

**检查清单：**
- [ ] API 密钥是否正确（注意不要有多余空格）
- [ ] 是否选择了正确的服务商（火山/微软）
- [ ] 火山翻译：Access Key 和 Secret Key 都填了吗？
- [ ] 微软翻译：Region 是否正确（如 eastasia）
- [ ] 网络是否正常
- [ ] 是否超出免费额度

**解决方法：**
1. 重新复制 API 密钥（确保无空格）
2. 检查 Background Service Worker 的日志
3. 确认 API 服务可用

### Q2: 选中文字后没有显示翻译

**检查清单：**
- [ ] 是否已保存 API 配置
- [ ] 是否启用了「划词翻译」
- [ ] 是否等待了 1 秒
- [ ] 选中的文字是否少于 500 字符
- [ ] 是否在支持的网页上（部分内部页面可能不支持）

**解决方法：**
1. 打开设置确认「启用划词翻译」已勾选
2. 选中文字后耐心等待 1 秒
3. 按 F12 查看控制台是否有错误

### Q3: 提示权限错误

**解决方法：**
```
1. 打开 edge://extensions/
2. 找到「翻译扩展」
3. 点击「详细信息」
4. 确保以下权限已启用：
   - 读取和更改您访问的网站上的数据
   - 存储
```

### Q4: 火山翻译配置后仍然失败

**检查 API 密钥格式：**
- Access Key ID: 通常是 `AKLT...` 开头
- Secret Access Key: 一长串随机字符

**测试方法：**
1. 登录火山引擎控制台
2. 访问机器翻译服务
3. 确认服务已开通
4. 重新生成密钥对

---

## 📝 配置示例

### 火山翻译配置示例
```
翻译服务提供商: 火山翻译
Access Key ID: AKLTxxxxxxxxxxxxxxxxxxxx
Secret Access Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 微软翻译配置示例
```
翻译服务提供商: 微软翻译
API Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Region: eastasia
```

---

## 🆘 获取帮助

如果以上方法都无法解决问题：

1. **导出配置**（隐私信息需脱敏）：
   ```javascript
   // 在 Background Service Worker 控制台执行
   chrome.storage.sync.get(null, console.log);
   ```

2. **查看完整错误信息**：
   - Background 控制台截图
   - Content 控制台截图
   - Options 页面测试结果

3. **提供测试环境信息**：
   - 浏览器版本
   - 扩展版本
   - 翻译服务商
   - 错误重现步骤

---

## ✨ 验证修复是否成功

### 测试步骤：

1. ✅ **测试配置保存**
   - 进入设置页面
   - 填写 API 密钥
   - 点击保存
   - 刷新页面，确认配置仍在

2. ✅ **测试 API 连接**
   - 点击「测试 API 连接」
   - 应该显示「✅ API 测试成功！」
   - 并显示翻译结果

3. ✅ **测试划词翻译**
   - 打开任意网页
   - 选中文字
   - 等待浮窗出现
   - 查看翻译结果

---

**祝使用顺利！** 🎉
